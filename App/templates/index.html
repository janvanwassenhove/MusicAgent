<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicAgent</title>
    <link rel="icon" type="image/x-icon" href="../static/favicon.ico">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Vue.js 3.5.12 -->
    <script src="https://unpkg.com/vue@3.5.12/dist/vue.global.js"></script>
    <!-- Axios for HTTP requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="../static/styles.css">
</head>
<body>
<div class="text-center py-2 mb-2" style="background-color: #1A4731;">
    <img src="../static/musicagent.png" alt="MusicAgent" style="max-width: 100%; height: 200px;">
</div>
<div id="app" class="container main_container p-4">
    <div class="row mt-4">
        <div class="col-12 py-4">
            <form  @submit.prevent="submitForm">
                <h3>Song Configuration</h3>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="api_provider" class="form-label">API Provider:</label>
                        <select v-model="formData.api_provider" id="api_provider" class="form-select" @change="updateModelOptions" required>
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="selected_model" class="form-label">Model:</label>
                        <select v-model="formData.selected_model" id="selected_model" class="form-select" required>
                            <option v-for="model in availableModels" :key="model" :value="model" v-text="model"></option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="agent_type" class="form-label">Select Agent Type:</label>
                        <div class="input-group">
                            <select v-model="formData.agentType" id="agent_type" class="form-select" @change="initializeAgent">
                                <option v-for="type in agentTypes" :key="type" :value="type" v-text="type"></option>
                            </select>
                            <button class="btn btn-outline-secondary" @click="openConfigDialog" :disabled="!formData.agentType">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div v-if="formData.api_provider === 'anthropic'" class="col-12 mb-3">
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Warning: Cover art creation won't be possible due to model restrictions when using Anthropic.
                        </div>
                    </div>
                </div>

                <div class="row" v-if="agentInitialized">
                    <div class="col-md-6 mb-3">
                        <label for="song_name" class="form-label">Song Name:</label>
                        <input v-model="formData.song_name" type="text" id="song_name" class="form-control" :class="{'is-invalid': errors.song_name}" required>
                        <div class="invalid-feedback" v-if="errors.song_name" v-text="errors.song_name"></div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="genre" class="form-label">Genre:</label>
                        <select v-model="formData.genre" id="genre" class="form-select" :class="{'is-invalid': errors.genre}" required>
                            <option v-for="genre in genres" :key="genre" :value="genre.genre" v-text="genre.genre"></option>
                        </select>
                        <div class="invalid-feedback" v-if="errors.genre" v-text="errors.genre"></div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <!--                        <label for="duration" class="form-label">Duration: {% raw %}<span id="durationValue">{{ formData.duration }}</span>{% endraw %} (seconds)</label>-->
                        <!--                        <input v-model.number="formData.duration" type="range" class="form-range" id="duration" min="30" max="360" :class="{'is-invalid': errors.duration}" required value="180">-->
                        <label for="duration" class="form-label">Duration [seconds]:</label>
                        <input v-model.number="formData.duration" type="number" id="duration" class="form-control" :class="{'is-invalid': errors.duration}" required value="180">
                        <div class="invalid-feedback" v-if="errors.duration" v-text="errors.duration"></div>
                    </div>
                    <div class="col-md-6 mb-3 ">
                        <label for="additional_information" class="form-label ">How do you imagine your song?</label>
                        <textarea v-model="formData.additional_information" id="additional_information" class="form-control" :class="{'is-invalid': errors.additional_information}"></textarea>
                        <div class="invalid-feedback" v-if="errors.additional_information" v-text="errors.additional_information"></div>
                    </div>
                    <div class="col-md-6 mb-3 justify-content-end  d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">Generate Music</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <hr>
    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#songParameters" aria-expanded="true" aria-controls="songParameters">
            <i class="fas fa-music"></i> Song Parameters
        </button>
        <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#timeline" aria-expanded="true" aria-controls="timeline">
            <i class="fas fa-stream"></i> Music Creation Timeline
        </button>
        <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#agentConversations" aria-expanded="true" aria-controls="agentConversations">
            <i class="fas fa-comments"></i> Agent Conversations
        </button>
        <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#musicAgentLogs" aria-expanded="true" aria-controls="musicAgentLogs">
            <i class="fas fa-file-alt"></i> Music Agent Logs
        </button>
        <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#sonicPiCode" aria-expanded="true" aria-controls="sonicPiCode">
            <i class="fas fa-code"></i> Sonic Pi Code
        </button>
    </div>
    <div class="row">
        <div id="songParameters" class="col-md-6 py-4 collapse show">
            <h3>Song Input Parameters</h3>
            <div id="parameters" class="border p-3 mb-3">
                {% raw %}
                <div v-if="Object.keys(parameters).length === 0">No parameters received yet.</div>
                <div v-else>
                    <div v-for="(value, key) in parameters" :key="key" class="mb-2">
                        <strong>{{ key || 'undefined key' }}:</strong> {{ value || 'undefined value' }}
                    </div>
                    <!--                    <div>Debug - Raw parameters: {{ JSON.stringify(parameters) }}</div>-->
                    <!--                    <div>Debug - Number of parameters: {{ Object.keys(parameters).length }}</div>-->
                </div>
                {% endraw %}
            </div>
        </div>
        <div id="timeline" class="col-md-6 py-4 collapse show">
            <h3>Music Creation Timeline</h3>
            <ul class="list-group" v-if="agentInitialized">
                {% raw %}
                <li v-for="(phase, index) in timeline" :key="index" class="list-group-item"
                    :class="{
                    'bg-info text-white': phase.phase === currentPhase,
                    'bg-success text-white': completedPhases.includes(phase.phase),
                    'bg-light': !completedPhases.includes(phase.phase) && phase.phase !== currentPhase
                    }">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <span class="badge bg-primary rounded-pill me-2">{{ index + 1 }}</span>
                            {{ phase.phase }}
                        </span>
                        <span v-if="phase.phaseType === 'ComposedPhase'" class="badge rounded-pill">
                            Cycles: {{ cycleCount(phase) }}/{{ phase.cycleNum }}
                        </span>
                        <span v-else-if="isSubphaseOfComposed(phase)" class="badge bg-secondary rounded-pill">
                            Parent Cycles: {{ cycleCount(phase) }}
                        </span>
                    </div>
                    <ul v-if="phase.phaseType === 'ComposedPhase'" class="list-group mt-2">
                        <li v-for="(subphase, subindex) in phase.Composition" :key="subindex"
                            class="list-group-item list-group-item-secondary"
                            :class="{
                            'bg-info text-white': subphase.phase === currentPhase,
                            'bg-success text-white': completedPhases.includes(subphase.phase),
                            'bg-light': !completedPhases.includes(subphase.phase) && subphase.phase !== currentPhase
                            }">
                            <span class="badge bg-secondary rounded-pill me-2">{{ index + 1 }}.{{ subindex + 1 }}</span>
                            {{ subphase.phase }}
                        </li>
                    </ul>
                </li>
                {% endraw %}
            </ul>
        </div>
    </div>

    <div id="agentConversations" class="py-4 collapse show">
        <h3>Agent Conversations</h3>
        <div id="chats" class="mt-4 mb-4 py-4"></div>
    </div>

    <div id="musicAgentLogs" class="py-4 collapse show">
        <h3>Music Agent Logs</h3>
        <div id="log" class="mt-4 cli-log py-4">
            <pre><code><span v-for="(message, index) in logMessages" :key="index" v-text="message"></span></code></pre>
        </div>
    </div>

    <div id="sonicPiCode" class="py-4 collapse show">
        <h3>Sample Sonic Pi Code</h3>
        <div class="mt-4 sonic-pi-code py-4">
            <div>
                <ul class="nav nav-tabs" id="sonicPiCodeTabs" role="tablist"></ul>
                <div class="tab-content" id="sonicPiCodeContent"></div>
            </div>
        </div>
    </div>
</div>

<footer class="container footer_container bg-dark text-white text-center py-3  mb-4">
    <div>
        <p class="mb-0">&copy; 2024 MusicAgent. All rights reserved.</p>
        <p class="mb-0">Follow mITy.John on
            <a href="https://www.instagram.com/mity.john/" class="text-white"><i class="fab fa-instagram"></i></a>
            <a href="https://www.linkedin.com/in/jan-van-wassenhove-9b49893/" class="text-white"><i class="fab fa-linkedin"></i></a>
            <a href="https://mityjohn.com/" class="text-white"><i class="fab fa-wordpress"></i></a>
            <a href="https://x.com/mity_john" class="text-white"><i class="fab fa-twitter"></i></a>
        </p>
    </div>
</footer>

<div id="inputModal" class="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Your input is Required</h5>
                <p>Please provide us your feedback:</p>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="inputPrompt"></p>
                <input type="text" id="userInput" class="form-control">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="submitInput">Submit</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configModalLabel">Edit {{ agentType }} Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea id="configJson" v-model="configJson" class="form-control json-textarea" rows="20" style="max-height: 60vh; overflow-y: auto;"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" @click="saveConfig">Save changes</button>
            </div>
        </div>
    </div>
</div>
<div class="alert alert-success alert-dismissible fade show" role="alert" id="completionAlert" style="display: none;">
    Song creation is finished!
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<script>

    function parseSonicPiCode(code) {
        const keywordRegex = /\b(live_loop|play|sleep)\b/g;
        const numberRegex = /\b\d+(\.\d+)?\b/g;
        const functionRegex = /(:\w+)/g;
        const doendRegex = /\b(do|end)\b/g;

        code = code.replace(keywordRegex, '<span class="keyword">$&</span>');
        code = code.replace(numberRegex, '<span class="number">$&</span>');
        code = code.replace(functionRegex, '<span class="function">$&</span>');
        code = code.replace(doendRegex, '<span class="doend">$&</span>');

        return code;
    }

    const { createApp, ref, onMounted, nextTick, reactive, computed } = Vue;
    const { watch } = Vue;

    createApp({
        setup() {
            const agentType = ref('');
            const agentTypes = ref([]);
            const agentInitialized = ref(false);
            const formSubmitted = ref(false);
            const formData = ref({
                genre: '',
                duration: 180,
                additional_information: '',
                song_name: '',
                agent_type: 'mITyJohn',
                api_provider: 'openai',
                selected_model: 'gpt-4o-mini'
            });
            const genres = ref([]);
            const logMessages = ref([]);
            const inputModal = ref(null);
            const inputPrompt = ref('');
            const userInput = ref('');
            const errors = ref({});

            const configJson = ref('');
            const configModal = ref(null);

            const timeline = ref([]);
            const currentPhase = ref('');
            const completedPhases = ref([]);
            const parameters = ref({});
            const currentCycle =  reactive({});

            const cycleCount = computed(() => (phase) => {
                if (phase.phaseType === 'ComposedPhase') {
                    const count = phase.phase in currentCycle ? currentCycle[phase.phase].count : 0;
                    return count;
                } else {
                    // For SimplePhase, find the parent ComposedPhase
                    const parentComposedPhase = timeline.value.find(p =>
                        p.phaseType === 'ComposedPhase' &&
                        p.Composition.some(subphase => subphase.phase === phase.phase)
                    );
                    if (parentComposedPhase) {
                        const count = parentComposedPhase.phase in currentCycle ? currentCycle[parentComposedPhase.phase].count : 0;
                        return count;
                    }
                    return 0;
                }
            });

            const formattedDuration = computed(() => {
                console.log('Computing formattedDuration', formData.value.duration);
                const minutes = Math.floor(formData.value.duration / 60);
                const seconds = formData.value.duration % 60;
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            });

            const isSubphaseOfComposed = (phase) => {
                return timeline.value.some(p =>
                    p.phaseType === 'ComposedPhase' &&
                    p.Composition.some(subphase => subphase.phase === phase.phase)
                );
            };

            let eventSource = null;
            let socket = null;

            const modelOptions = {
                "openai": ["gpt-4o", "gpt-4o-mini", "gpt-3.5-turbo", "gpt-4", "gpt-4-32k"],
                "anthropic": ["claude-3-5-sonnet-20240620", "claude-3-sonnet-20240229", "claude-3-haiku-20240307"]
            };

            const availableModels = ref([]);

            const updateModelOptions = () => {
                availableModels.value = modelOptions[formData.value.api_provider] || [];
                if (!availableModels.value.includes(formData.value.selected_model)) {
                    formData.value.selected_model = availableModels.value[0] || '';
                }
            };

            // Call updateModelOptions initially to set the default options
            updateModelOptions();

            const resetCurrentPhase = () => {
                this.currentPhase = '';
                this.completedPhases = [];
            };

            const resetDivsForNewSong = () => {
                resetCurrentPhase();
                this.timeline = [];
                this.parameters = {};
                const chatsDiv = document.getElementById('chats');
                chatsDiv.innerHTML = '';
            };

            const fetchTimeline = async () => {
                try {
                    const response = await axios.get('/timeline', {
                        params: { agent_type: formData.value.agentType }
                    });
                    timeline.value = response.data.chain;
                } catch (error) {
                    console.error('Error fetching timeline:', error);
                }
            };

            const fetchAgentTypes = () => {
                axios.get('/agent_types')
                    .then(response => {
                        if (response.data && response.data.agent_types) {
                            agentTypes.value = response.data.agent_types;
                        } else {
                            console.error('Unexpected response format:', response.data);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching agent types:', error);
                    });
            };

            const initializeAgent = () => {
                resetCurrentPhase();

                axios.post('/init', { agent_type: agent_type.value })
                    .then(response => {
                        genres.value = response.data.genres;
                        agentInitialized.value = true;
                    })
                    .catch(error => {
                        console.error('Error initializing agent:', error);
                    });
            };

            const validateForm = () => {
                errors.value = {};
                if (!formData.value.genre) {
                    errors.value.genre = 'Please select a genre';
                }
                if (!formData.value.duration || formData.value.duration <= 0) {
                    errors.value.duration = 'Please enter a valid duration';
                }
                if (!formData.value.song_name.trim()) {
                    errors.value.song_name = 'Please enter a song name';
                }
                return Object.keys(errors.value).length === 0;
            };

            const submitForm = () => {
                if (validateForm()) {
                    formSubmitted.value = true;
                    resetCurrentPhase();
                    resetDivsForNewSong();

                    axios.post('/', formData.value)
                        .then(() => {
                            startEventSource();
                        })
                        .catch(error => {
                            console.error('Error submitting form:', error);
                        });
                } else {
                    console.log('Form validation failed');
                }
            };

            const setupSocketIO = () => {
                console.log('Setting up SocketIO');
                socket = io();

                socket.on('connect', () => {
                    console.log('Connected to server');
                });

                socket.on('disconnect', () => {
                    console.log('Disconnect from server');
                });

                socket.on('input_required', (data) => {
                    console.log('Input required event received:', data);
                    inputPrompt.value = data.prompt;
                    nextTick(() => {
                        inputModal.value.show();
                    })
                });

                socket.on('process_complete', (data) => {
                    console.log('Process complete:', data.message);
                    logMessages.value.push(data.message);
                    // You might want to do something else when the process is complete
                });
            };

            const submitUserInput = () => {
                const userInput = document.getElementById('userInput').value;
                socket.emit('submit_input', { input: userInput });
                inputModal.value.hide();
            };

            let sonicPiCodeVersions = [];

            const fetchSonicPiCode = async (songname) => {
                try {
                    const response = await axios.get(`/get_sonicpi_code/${songname}`);
                    console.info('Polling for sonic pi file');
                    if (response.data.sonicpi_code) {
                        const newCode = response.data.sonicpi_code;
                        if (!sonicPiCodeVersions.includes(newCode)) {
                            console.info('New Version Code Found:', newCode);
                            sonicPiCodeVersions.push(newCode);
                            updateSonicPiCodeTabs();
                        }
                    }
                } catch (error) {
                    console.error('Error fetching Sonic Pi code:', error);
                }
            };

            const updateSonicPiCodeTabs = () => {
                const tabsContainer = document.getElementById('sonicPiCodeTabs');
                const contentContainer = document.getElementById('sonicPiCodeContent');
                tabsContainer.innerHTML = '';
                contentContainer.innerHTML = '';

                sonicPiCodeVersions.forEach((code, index) => {
                    const tabId = `sonicPiCodeTab${index}`;
                    const contentId = `sonicPiCodeContent${index}`;

                    // Create tab
                    const tab = document.createElement('button');
                    tab.className = 'nav-link';
                    tab.id = `${tabId}-tab`;
                    tab.setAttribute('data-bs-toggle', 'tab');
                    tab.setAttribute('data-bs-target', `#${contentId}`);
                    tab.type = 'button';
                    tab.role = 'tab';
                    tab.ariaControls = contentId;
                    tab.ariaSelected = index === 0 ? 'true' : 'false';
                    tab.innerText = `Version ${index + 1}`;
                    tabsContainer.appendChild(tab);

                    // Create content
                    const content = document.createElement('div');
                    content.className = 'tab-pane fade';
                    content.id = contentId;
                    content.role = 'tabpanel';
                    content.ariaLabelledby = `${tabId}-tab`;
                    content.innerHTML = `<pre><code>${parseSonicPiCode(code)}</code></pre>`;
                    contentContainer.appendChild(content);

                    if (index === 0) {
                        tab.classList.add('active');
                        content.classList.add('show', 'active');
                    }
                });

                // Re-initialize Bootstrap tab functionality
                const tabElements = document.querySelectorAll('#sonicPiCodeTabs button[data-bs-toggle="tab"]');
                tabElements.forEach(tab => {
                    new bootstrap.Tab(tab);
                });
            };

            const startEventSource = () => {
                if (eventSource) {
                    eventSource.close();
                }
                resetCurrentPhase();
                eventSource = new EventSource("/stream");

                eventSource.onopen = (e) => {
                    console.log("EventSource connection opened");
                };

                eventSource.onmessage = (e) => {
                    console.log("Received message:", e.data);
                    if (formSubmitted.value && e.data.includes('"sonicpi_code"')) {
                        fetchSonicPiCode(formData.value.song_name);
                    }
                    if (e.data === "DONE") {
                        const completionAlert = document.getElementById('completionAlert');
                        completionAlert.style.display = 'block';
                        formSubmitted.value = false;
                        fetchSonicPiCode(formData.value.song_name);
                        // eventSource.close();
                    } else if (e.data.startsWith("input_required|")) {
                        const [, prompt] = e.data.split("|");
                        inputPrompt.value = prompt;
                        inputModal.value.show();
                    } else {

                        const parameterRegexQuestioner = /\[Questioner\]\(([A-Za-z0-9_\s]+)\):\[\[(.*?)\]\]/g;
                        const matchesQuestioner = [...e.data.matchAll(parameterRegexQuestioner)];
                        const chatsDiv = document.getElementById('chats');
                        matchesQuestioner.forEach(match => {
                            const firstParam = match[1];
                            const secondParam = match[2];

                            // Create the container for the chat message
                            const chatMessage = document.createElement('div');
                            chatMessage.className = 'chat-message d-flex align-items-start mb-3';

                            // Create the image element
                            const img = document.createElement('img');
                            img.src = `../static/assistants/${firstParam}.webp`;
                            img.onerror = () => {
                                img.src = '../static/assistants/Unknown.webp';
                            };
                            img.alt = firstParam;
                            img.className = 'chat-image me-3';

                            // Create the text container
                            const textContainer = document.createElement('div');
                            textContainer.className = 'chat-text p-3 rounded';

                            // Create the text content
                            const textContent = document.createElement('div');
                            const maxLength = 1000; // Adjust the length as needed
                            textContent.innerHTML = `<strong>${firstParam}:</strong> `;
                            for (let i = 0; i < secondParam.length; i += maxLength) {
                                textContent.innerHTML += `<em>${secondParam.substring(i, i + maxLength)}</em>`;
                            }

                            // Append elements
                            textContainer.appendChild(textContent);
                            chatMessage.appendChild(img);
                            chatMessage.appendChild(textContainer);
                            chatsDiv.appendChild(chatMessage);
                        });

                        const parameterRegexAssistant = /\[Assistant\]\(([A-Za-z0-9_\s]+)\):\[\[(.*?)\]\]/g;
                        const matchesAssistant = [...e.data.matchAll(parameterRegexAssistant)];
                        matchesAssistant.forEach(match => {
                            const firstParam = match[1];
                            const secondParam = match[2];

                            // Create the container for the chat message
                            const chatMessage = document.createElement('div');
                            chatMessage.className = 'chat-message d-flex align-items-start justify-content-end mb-3';

                            // Create the text container
                            const textContainer = document.createElement('div');
                            textContainer.className = 'chat-text p-3 rounded me-3';

                            // Create the text content
                            const textContent = document.createElement('div');
                            const maxLength = 1000; // Adjust the length as needed

                            if (secondParam.startsWith("Cover image generated https://")) {
                                const url = secondParam.split(" ")[3];
                                textContent.innerHTML = `<strong>${firstParam}:</strong> <em>Cover image generated:</em> <img src="${url}" alt="Cover Image" style="max-width: 100%; height: auto;">`;
                            } else {
                                textContent.innerHTML = `<strong>${firstParam}:</strong> `;
                                for (let i = 0; i < secondParam.length; i += maxLength) {
                                    textContent.innerHTML += `<em>${secondParam.substring(i, i + maxLength)}</em>`;
                                }
                            }

                            // Create the image element
                            const img = document.createElement('img');
                            img.src = `../static/assistants/${firstParam}.webp`;
                            img.onerror = () => {
                                img.src = '../static/assistants/Unknown.webp';
                            };
                            img.alt = firstParam;
                            img.className = 'chat-image';

                            // Append elements
                            textContainer.appendChild(textContent);
                            chatMessage.appendChild(textContainer);
                            chatMessage.appendChild(img);
                            chatsDiv.appendChild(chatMessage);
                        });


                        const parameterRegex = /\[([A-Z_]+)\]:\[(.*?)\]/g;
                        const paramMatches = [...e.data.matchAll(parameterRegex)];

                        // console.log("Parameter matches:", paramMatches);

                        if (paramMatches.length > 0) {
                            paramMatches.forEach(match => {
                                const [, key, value] = match;
                                parameters.value[key] = value.trim();
                            });
                            // console.log("Updated parameters:", parameters.value);
                        } else {
                            // console.log("Received message pushing to logMessages");
                            logMessages.value.push(e.data);

                            const phaseStartMatch = e.data.match(/Executing phase: \[(.+)\]/);
                            if (phaseStartMatch) {
                                const newPhase = phaseStartMatch[1].trim();

                                // Find the parent ComposedPhase
                                const composedPhase = timeline.value.find(phase =>
                                    phase.phaseType === 'ComposedPhase' &&
                                    phase.Composition.some(subphase => subphase.phase === newPhase)
                                );

                                if (composedPhase) {
                                    const composedPhaseName = composedPhase.phase;
                                    if (!(composedPhaseName in currentCycle)) {
                                        console.log("Initializing currentCycle for", composedPhaseName);
                                        currentCycle[composedPhaseName] = {
                                            count: 0,
                                            currentSubphase: ''
                                        };
                                    }

                                    // Check if we're starting the first subphase
                                    if (composedPhase.Composition[0].phase === newPhase &&
                                        currentCycle[composedPhaseName].currentSubphase !== newPhase) {
                                        currentCycle[composedPhaseName].count++;
                                    }
                                    currentCycle[composedPhaseName].currentSubphase = newPhase;

                                    // Check if all cycles are finished
                                    if (currentCycle[composedPhaseName].count === composedPhase.cycleNum) {
                                        completedPhases.value.push(composedPhaseName);
                                    }
                                }

                                if (currentPhase.value) {
                                    completedPhases.value.push(currentPhase.value);
                                }
                                currentPhase.value = newPhase;
                            }

                            nextTick(() => {
                                const logDiv = document.getElementById('log');
                                logDiv.scrollTop = logDiv.scrollHeight;
                            });
                        }
                    }
                };
                eventSource.onerror = (e) => {
                    console.error('EventSource error:', e);
                    logMessages.value.push('Error in event stream. Please check server logs.');
                    eventSource.close();
                };
            };

            watch(() => formData.value.api_provider, updateModelOptions);
            watch(() => formData.value.agentType, () => {
                configJson.value = '';
                resetCurrentPhase();
                fetchTimeline();
            });

            watch(genres, (newGenres) => {
                if (newGenres.length > 0 && !formData.value.genre) {
                    formData.value.genre = newGenres[0].genre;
                }
            });
            const openConfigDialog = async () => {
                if (!formData.value.agentType) return;

                try {
                    const response = await axios.get(`/agent_config/${formData.value.agentType}`);
                    configJson.value = JSON.stringify(response.data, null, 2);
                    nextTick(() => {
                        configModal.value.show();
                    });
                } catch (error) {
                    console.error('Error fetching agent config:', error);
                }
            };

            const saveConfig = async () => {
                try {
                    const parsedConfig = JSON.parse(configJson.value);
                    await axios.post(`/agent_config/${formData.value.agentType}`, parsedConfig);
                    configModal.value.hide();
                    initializeAgent();
                } catch (error) {
                    console.error('Error saving agent config:', error);
                    alert('Invalid JSON or error saving configuration');
                }
            };

            onMounted(() => {
                fetchAgentTypes();
                inputModal.value = new bootstrap.Modal(document.getElementById('inputModal'), {
                    backdrop: 'static',
                    keyboard: false
                });

                document.getElementById('submitInput').addEventListener('click', submitUserInput);
                setupSocketIO();
                startEventSource();

                configModal.value = new bootstrap.Modal(document.getElementById('configModal'), {
                    backdrop: 'static',
                    keyboard: false
                });
                document.getElementById('configModal').addEventListener('shown.bs.modal', () => {
                    // This ensures the textarea is updated after the modal is fully visible
                    nextTick(() => {
                        const textarea = document.querySelector('#configModal textarea');
                        if (textarea) {
                            textarea.value = configJson.value;
                            textarea.style.height = 'auto';
                            textarea.style.height = textarea.scrollHeight + 'px';
                        }
                    });
                });
                updateModelOptions();
                fetchTimeline();

                // Set default genre if available
                if (genres.value.length > 0) {
                    formData.value.genre = genres.value[0].genre;
                }
            });

            return {
                agentType, agentTypes, agentInitialized, initializeAgent,
                formData, formattedDuration,
                genres,
                logMessages,
                errors,
                inputPrompt,
                submitForm,
                submitUserInput,
                userInput,
                configJson,
                openConfigDialog,
                saveConfig,
                timeline, fetchTimeline,
                currentPhase, completedPhases, resetCurrentPhase, currentCycle, cycleCount, isSubphaseOfComposed,
                availableModels, updateModelOptions,
                parameters

            };
        }
    }).mount('#app');
</script>
</body>
</html>
